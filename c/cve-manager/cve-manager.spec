%define controlppver 0.9
%define import cve-import
%define map cpe-map
%define monitor cve-monitor
%define issues cve-issues
%define fixes cve-fixes
%define download cve-download
%define backup cve-backup

Name: cve-manager
Version: 0.11.0
Release: alt1

Summary: CVE-management toolkit
License: GPLv3
Group: Other
Url: https://www.altlinux.org/CVE-Manager

Packager: Alexey Appolonov <alexey@altlinux.org>

# http://git.altlinux.org/people/alexey/packages/?p=cve-manager.git
Source: %name-%version.tar

# For cve-import
BuildRequires: gcc-c++
BuildRequires: libcontrol++-devel >= %controlppver
BuildRequires: libmysqlcppconn-devel
BuildRequires: libxml++2-devel
BuildRequires: libcurl-devel

# For py-modules
Requires: python3
Requires: python3-module-mysql
Requires: python3-module-Levenshtein
Requires: %import
Requires: %fixes
Requires: %map
Requires: %issues
Requires: %monitor
Requires: %download
Requires: %backup

ExclusiveArch: x86_64

%description
cve-manager is a command line utilities toolkit
used to import various CVE lists (in CSV or XML formats)
into MySQL DB, getting access to and analyse formed CVE DB.

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# cve-import

%package -n %import
Summary: Data parser and MySQL DB importer
Group: Other

%description -n %import
cve-import is a command line utility that can import
various CVE lists (in CSV or XML formats) into MySQL DB.

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# cpe-map

%package -n %map
Summary: CPE list to software packages list mapper
Group: Other

%description -n %map
%map is a command line utility that can map
CPE list to software packages list.

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# cve-monitor

%package -n %monitor
Summary: CVE database monitor
Group: Other

%description -n %monitor
%monitor is a command line utility used to query CVE database.

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# cve-issues

%package -n %issues
Summary: CVE-issues detector
Group: Other

%description -n %issues
%issues is a command line utility used to detect CVE-issues.

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# cve-fixes

%package -n %fixes
Summary: CVE-fixes entries handler
Group: Other

%description -n %fixes
%fixes is a command line utility used to retrieve CVE-fixes entries
from changelogs of all the packages and push them into the CVE DB.

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# cve-download

%package -n %download
Summary: CVE-lists and CPE dictionary downloader
Group: Other

%description -n %download
%download is a command line utility used to download CVE-lists
and CPE dictionary via https.

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# cve-backup

%package -n %backup
Summary: CVE DB backupper/restorer
Group: Other

%description -n %backup
%backup is a command line utility 'used to backup/restore CVE DB.

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

%prep
%setup

%build
mkdir -p bin/Release
mkdir -p obj/Release
%make_build -C cve-import/ release

%install
mkdir -p %buildroot%_bindir
mkdir -p %buildroot%_defaultdocdir/%name/
mkdir -p %buildroot%_sysconfdir/%name
# Executables
cp %name %buildroot%_bindir
cp %name-common.py %buildroot%_bindir
cp cve-import/bin/Release/%import %buildroot%_bindir
cp %map %buildroot%_bindir
cp %monitor %buildroot%_bindir
cp %issues %buildroot%_bindir
cp %fixes %buildroot%_bindir
cp %download %buildroot%_bindir
cp %backup %buildroot%_bindir
cp gb-x-parse-vulns-from-changelog %buildroot%_bindir
# Configuration - users should be added to "cve" group to use cve-manager
cp -r samples/* %buildroot%_sysconfdir/%name
chmod 640 %buildroot%_sysconfdir/%name/%name.conf
# Documentation
cp COPYING %buildroot%_defaultdocdir/%name/
cp readme.txt %buildroot%_defaultdocdir/%name/
cp usage.txt %buildroot%_defaultdocdir/%name/%name-usage.txt
cp cve-import/usage.txt %buildroot%_defaultdocdir/%name/%import-usage.txt

%post
groupadd cve
chgrp cve %_sysconfdir/%name/%name.conf

%files
%_bindir/%name
%_bindir/%name-common.py
%_sysconfdir/%name/
%config(noreplace) %_sysconfdir/%name/%name.conf
%dir %_defaultdocdir/%name/
%_defaultdocdir/%name/%name-usage.txt

%files -n %import
%_bindir/%import
%_sysconfdir/%name/%name.conf
%_defaultdocdir/%name/%import-usage.txt

%files -n %map
%_bindir/%map

%files -n %monitor
%_bindir/%monitor

%files -n %issues
%_bindir/%issues

%files -n %fixes
%_bindir/%fixes
%_bindir/gb-x-parse-vulns-from-changelog

%files -n %download
%_bindir/%download

%files -n %backup
%_bindir/%backup

%changelog
* Thu May 31 2018 Alexey Appolonov <alexey@altlinux.org> 0.11.0-alt1
- Ability to set starting step for auto mode in main module;
- Usage examples for cve-download;
- Arguments handling fix in cve-issues;
- Only root can modify cve-manager.conf.

* Mon May 28 2018 Alexey Appolonov <alexey@altlinux.org> 0.10.0-alt1
- New module cve-backup;
- Ability to prepare database in auto mode.

* Fri May 21 2018 Alexey Appolonov <alexey@altlinux.org> 0.9.0-alt1
- Full integration of the FSTEC vulnerabilities list;
- Bin packages matching fix;
- Ability to use custom mapping application;
- Memory leakage fix.

* Fri May 4 2018 Alexey Appolonov <alexey@altlinux.org> 0.8.0-alt1
- New module cve-download.py
- "Fixes" entries now stored in *_src tables;
- Importing bin lists;
- Enhanced mapping algorithm;
- Unescaping URL codes from CPE in cve-import;
- More flexibility in cve-import tables recreation;
- Ability to disable entireline output in cve-import;
- Catching run modes with cve-manager-common.py;
- Using argparse in majority of modules;
- cve-fixes new features;
- Monitoring CVE issues table and monitoring CVE descriptions for the packages;
- Single path for CVE lists and CPE dict import that specified
  in configuration file.

* Fri Mar 16 2018 Alexey Appolonov <alexey@altlinux.org> 0.7.0-alt1
- Improved output format;
- CPE dict names import with sections separation;
- Fixed and improved mapping algorithm;
- Fixes-extraction parts completely removed from cve-import;
- Working version of cve-linker module under new name "cve-issues.py";
- New cve-monitor functionality;
- Various fixes and improvements in py-modules.

* Mon Mar 05 2018 Alexey Appolonov <alexey@altlinux.org> 0.6.0-alt1
- New cve-manager-common.py features and improvements;
- New module cve-linker.py;
- New module cve-fixes.py;
- Fixes tables structure changed;
- Error handling correction when applying configuration for cve-import module.

* Thu Mar 01 2018 Alexey Appolonov <alexey@altlinux.org> 0.5.0-alt1
- Taking CPE name from "name" attribute of the "cpe-item" tag,
  not from "cpe-23:cpe23-item" tag;
- CPE dictionary can be imported directly, without creating CSV file,
  just like NVD XML can be;
- New cve-manager-common.py functionality;
- Sending cpe-packages map to the database;
- Monitoring mapped packages.

* Mon Feb 26 2018 Alexey Appolonov <alexey@altlinux.org> 0.4.0-alt1
- CPE dictionary import;
- New cve-manager-common.py module with common functions and classes
  used by other cve-manager py-modules;
- cve-monitor rewritten with the use of cve-manager-common.py;
- CPE mapper (cpe-map.py) first draft;
- Changes in cve-manager.py debug mode.

* Thu Feb 19 2018 Alexey Appolonov <alexey@altlinux.org> 0.3.0-alt1
- New version of main module written in Python;
- New module "cve-monitor";
- Minor fixes.

* Thu Feb 15 2018 Alexey Appolonov <alexey@altlinux.org> 0.2.1-alt1
- common* and conf* files was removed from the project because
  they are included in dynamically linked libcontrol++.

* Wed Feb 14 2018 Alexey Appolonov <alexey@altlinux.org> 0.2.0-alt1
- What previously known as "cve-manager" now became
  "cve-import" module of the cve-manager toolkit
  with "cve-manager" script as top level module.

* Tue Feb 13 2018 Alexey Appolonov <alexey@altlinux.org> 0.1.2-alt1
- Fixing usage of branches flags from configuration file;
- Changes in display output for the operations status.

* Wed Jan 31 2018 Alexey Appolonov <alexey@altlinux.org> 0.1.1-alt1
- Chmod of configuration file (only system administrator
  should know MySQL DB password);
- MySQL authentication bug fixed;
- Handling the situation when packages lists can not be found;
- Removing formed CSV file with NVD CVE list right after import to DB.

* Mon Jan 29 2018 Alexey Appolonov <alexey@altlinux.org> 0.1.0-alt1
- Initial release.
